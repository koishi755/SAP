# 1. 3層アーキテクチャ
3層アーキテクチャはSAPの代表的な構成です。

![3層アーキテクチャ](https://github.com/koishi755/SAP/blob/main/SAP%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/3%E5%B1%A4%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%88.png)
<br>

## 1.1. Client Tier(Presentation Tier)
SAPを使用するためのレイヤーです。
<br>

### SAP GUI
クライアントソフトウェア
エンドユーザーはSAP GUIを通じてSAPとデータのやり取りを行います。
<br>

### WEB GUI
ブラウザからアクセスするSAP GUI。<br>
Java用のSAP GUIもあります。<br>
<br>

### RFC (Remote Function Call)
リモートファンクションコールはSAPサーバーと別のSAPサーバーの接続で使用されます。<br>
またMicrosoft Serverもやその他のサードパーティ製もサポートしておりSAPからデータを取得することができます。<br>
そのためクライアントレイヤーに位置すると考えられる。(エクセルやVBAにて使用可能)<br>
<br>

### HTML or SOAP Client
NWBCと言われるアプリケーション。NWBCはWeb GUIのようなアプリケーションでローカルPCへインストールが必要です。<br>
<br>

## 1.2. Application Tier
アプリケーション層には、実際のSAPシステムが置かれています。<br>
SAPにはプログラムとテーブルがありますが、アプリケーション層はプログラムが保存され、実行されるレイヤーです。<br>
多くのアプリケーションサーバーが存在する可能性があり、セントラルインスタンスとアプリケーションインスタンスがあります。<br>
<br>

## 1.3. データベース層
データベース層では様々なDBを使用できます。Microsoft SQL Server、Oracle、HANAなどを使用できます。<br>
SAPは独自のDBであるHANAを推進しています。HANAはSAPDBとも呼ばれます。<br>
小規模なシステムの場合、広く普及していませんが、SAPDBを使用することも可能です。<br>
<br>

# 2. SAPインスタンス
SAPインスタンスは、次のようなリソースのグループです。

* Memory
* Work Processes
* Dispatcher
* Gateway

SAPインスタンスには次の３つタイプがあります。
1. Dialog instance
2. Central Instance
3. Database Instance

![インスタンス](https://github.com/koishi755/SAP/blob/main/SAP%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9.png)

## 2.1. Dialog instance
ダイアログインスタンスはアプリケーション層に存在します。スケーラビリティと負荷分散の目的でインストールされた追加のアプリケーションサーバーインスタンスは、ダイアログインスタンスと呼ばれます。<br>
ダイアログインスタンスには、追加のダイアログ、バッチ、スプール、および更新ワークプロセスがあります。 <br>
すべてのダイアログインスタンスは、メッセージサーバにデータベースをリクエストする前に、セントラルインスタンスと通信します。<br>
ダイアログインスタンスの数が増えると、ハードウェアリソース、ディスパッチャ、ワークプロセスも増え、一度にログインできるユーザーの数が増えます。<br>
<br>

## 2.2. Central Instance
セントラルインスタンスは、単一のホストマシンにあるエンキューおよびメッセージサービスを含む、SAP システムのアプリケーションサービスを指します。<br>
セントラルインスタンスには、ダイアログ、アップデート、およびバックグラウンドサービス用の複数のワークプロセスがあります。<br>
それらが実行されるマシンは、セントラルホストと呼ばれます。<br>
インスタンスが起動すると、ディスパッチャプロセスはメッセージサーバへの接続を確立します。<br>



## 2.3. Database Instance
SAP アプリケーションの基礎となるデータベースに関連付けられているインスタンスは、データベースインスタンスと呼ばれます。<br>
以下はOracleインスタンスの例<br>
![Oracleインスタンス](https://github.com/koishi755/SAP/blob/main/SAP%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/Oracle%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9.png)

# 3. アプリケーションレイヤーのコンポートネント
<br>

## 3.1.  Dispatcher
SAP ディスパッチャーは、アプリケーションサーバー上の中心的なプロセスで、次のような動作を行います。
* SAP プロファイルのパラメーターの読み込み
* ワークプロセスの開始
* メッセージサーバへのログオン
* プレゼンテーション層(SAP GUI)への接続
* 設定されたすべてのワークプロセスに負荷を均等に分散する

また下図ようにアプリケーションサーバーごとに 1 つのディスパッチャーが存在します。<br>


![インスタンス詳細](https://github.com/koishi755/SAP/blob/main/SAP%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E8%A9%B3%E7%B4%B0.png)


### ユーザリクエストの流れ
1. ユーザーはプレゼンテーションサーバーにデータを入力します。データはSAPGUIで受信され、SAPフォーマットに変換され、DIAGと呼ばれる特別に最適化されたプロトコルを使用してディスパッチャーに送信されます。
2. 最初のうちは、ディスパッチャーはリクエストをキューに入れておき、後でそれらを一つずつ処理します。
3. ディスパッチャーは、空いているプロセスにユーザの要求を割り当てます。
4. 処理の最後に、ワークプロセスタスクの結果は、ディスパッチャを通じて SAPGUI に戻ります。SAPGUI は受信したデータを解釈し、ユーザー画面に反映する。

## 3.2. Message Server
メッセージサーバーはセントラルインスタンスに置かれ、それぞれディスパッチャーとコミュニケートします。
それぞれのディスパッチャーは特定のワークプロセスにリクエストを送信します。
メッセージサーバはそれぞれのディスパッチャーの制御を行います。

主な役割
* 負荷分散
* ユーザーがログインするアプリケーションサーバーを決定する
* アプリケーションサーバー間の通信を提供する


## 3.3. Work Process
SAP ワークプロセスは、SAPABAP リクエストの個々のダイアログステップを実行します。ワークプロセスのアーキテクチャは、限られた数のワークプロセスが多くのユーザーを同時にサポートできるように設計されています。ディスパッチャーはSAPフロントエンドからリクエストを収集し、実行のためにワークプロセスに転送します。SAP NW AS ABAP にはいくつかの異なるタイプのワークプロセスがあり、各ワークプロセスタイプには特定の機能があります。<br>

![ワークプロセス全体像](https://github.com/koishi755/SAP/blob/main/SAP%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%85%A8%E4%BD%93%E5%83%8F.png)
<br>

### Dialog Work Process
ダイアログワークプロセスは、ダイアログプログラムを実行します。

### Update Work Process
アップデートワークプロセスは、データベースの更新を実行します。アップデートワークプロセスには、U1 と U2 の2 種類があります。U1 タイプは、発注や資材の移動など、一次およびタイムクリティカルな更新を実行します。U2 タイプは、統計更新などの2次および重要ではない更新を実行します。

### Background Work Process
バックグラウンドワークプロセスは、アプリケーションサーバーに送信されたバックグラウンドジョブを実行します。

### Spool Work Process
スプールワークプロセスは、アプリケーションサーバーに送信されたスプール依頼を実行します。

### Enqueue Work Process
エンキューワークプロセスは、アプリケーションロックを管理します。

## 3.4. AS ABAP Processes

![AS ABAP Processes](https://github.com/koishi755/SAP/blob/main/SAP%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/AS%20ABAP%20Processes.png)
### Gateway
ゲートウェイサービスは、さまざまな SAP システムと外部システム間の通信を担当します。<br>
外部のSAPシステムへのリクエストはまずゲートウェイサーバーに送信され、その後それぞれのSAPシステムに送信されます。

### Inertnet Communication Server(ICM)
インターネットコミュニケーションサーバーはウェブリクエストを制御します。

# SAP NetWeaver Application Server with ABAP and Java
[詳しくはこちら！](https://help.sap.com/doc/saphelp_nw73/7.3.16/en-US/48/03b72c49f04aa5e10000000a421937/frameset.htm)

[日本語資料](https://help.sap.com/doc/saphelp_nw70/7.0.12/ja-JP/53/97583c2439e66fe10000000a114084/frameset.htm)
![ABAP and Java](https://help.sap.com/doc/saphelp_nw73/7.3.16/en-US/48/03b72c49f04aa5e10000000a421937/loio4803b72e49f04aa5e10000000a421937_LowRes.png)















